<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NetCDF Viewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

    <div class="container py-5">

        <h2 class="mb-4 text-center">NetCDF Viewer</h2>

        <!-- Intro Box -->
        <div class="alert alert-info">
            <p><strong>Welcome to the NetCDF Viewer!</strong></p>
            <p>NetCDF files store multi-dimensional scientific datasets such as temperature or precipitation.</p>
            <p>Upload a file, explore variables, and visualise time steps interactively.</p>
        </div>


        <!-- Upload Form -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">

                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}

                    {% if nc_file_instance %}
                    <input type="hidden" name="existing_file_id" value="{{ nc_file_instance.id }}">
                    {% endif %}

                    {{ form.as_p }}

                    <button type="submit" class="btn btn-primary">Upload</button>
                </form>

            </div>
        </div>


        {% if variables %}
        <!-- Variable + Time Controls -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">

                <form method="post" class="row g-3">
                    {% csrf_token %}

                    <input type="hidden" name="existing_file_id" value="{{ nc_file_instance.id }}">

                    <!-- Variable Dropdown -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Select variable</label>
                        <select name="variable" class="form-select" onchange="this.form.submit()">
                            {% for var in variables %}
                            <option value="{{ var }}" {% if var == selected_var %}selected{% endif %}>
                                {{ var }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>


                    {% if times %}
                    <!-- Time Slider -->
                    <div class="col-12 mt-3">

                        <label class="form-label fw-bold">Select time step</label>

                        <input type="range"
                               class="form-range"
                               id="timeSlider"
                               name="time_idx"
                               min="0"
                               max="{{ times|length|add:'-1' }}"
                               value="{{ selected_time_idx }}"
                               oninput="updateTimeLabel(this.value)"
                               onchange="this.form.submit()">

                        <!-- Visual tick marks -->
                        <div class="d-flex justify-content-between small text-muted">
                            {% for t in times %}
                            <span>|</span>
                            {% endfor %}
                        </div>

                        <!-- Value readout -->
                        <div class="mt-2">
                            <strong>Selected time:</strong>
                            <span id="timeLabel">
                                {{ selected_time }}
                            </span>
                        </div>

                        <!-- Tick number labels -->
                        <div class="d-flex justify-content-between small text-muted mt-1">
                            {% for t in times %}
                            <span title="{{ t }}">{{ forloop.counter0 }}</span>
                            {% endfor %}
                        </div>

                    </div>
                    {% endif %}

                </form>

            </div>
        </div>
        {% endif %}


        {% if metadata %}
        <!-- Metadata Box -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title">Metadata</h5>

                <ul class="list-group list-group-flush">
                    <li class="list-group-item"><strong>Dimensions:</strong> {{ metadata.dimensions }}</li>
                    <li class="list-group-item"><strong>Variables:</strong> {{ metadata.variables }}</li>
                    <li class="list-group-item"><strong>Times:</strong> {{ metadata.times }}</li>
                </ul>
            </div>
        </div>
        {% endif %}


        {% if plot_html %}
        <!-- Interactive Plot -->
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Interactive Plot</h5>
                {{ plot_html|safe }}
            </div>
        </div>
        {% endif %}

    </div>


    <!-- JS: Update time label -->
    {% if times %}
    <script>
    const timeLabels = JSON.parse('{{ times|safe|escapejs }}');

    function updateTimeLabel(idx) {
        document.getElementById("timeLabel").textContent = timeLabels[idx];
    }
    </script>
    {% endif %}

</body>
</html>
